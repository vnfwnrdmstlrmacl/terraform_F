# group_vars/db/main.yml
# DB에서는 etcd를 절대 설치/관리하지 않음





db_manage_etcd: false


# Vault 파일 경로(필요시 사용)
db_vault_vars_file: "{{ playbook_dir }}/group_vars/db/vault.yml"

# -----------------------------
# 네트워크
# -----------------------------
db_subnet_cidr: "10.2.3.0/24"
db_gateway_vip: "10.2.3.254"

# (서비스/프록시 등 외부(내부서비스) 대역)
svc_subnet_cidr: "10.2.2.0/24"
svc_vip: "10.2.2.254"


# -----------------------------
# PostgreSQL / Patroni
# -----------------------------
pg_version: 16
pg_login_host: "{{ ansible_host }}"
pg_port: 5432

# Patroni REST API address (Ansible용)
patroni_rest_host: "{{ ansible_host }}"
patroni_rest_port: 8008
patroni_scope: "pg-ha"
patroni_namespace: "/service/"

# Patroni가 사용할 PostgreSQL 경로
# (RHEL/Rocky 기본 postgresql 패키지 기준: /usr/bin)
patroni_pg_bin_dir: "/usr/bin"
patroni_pg_data_dir: "/var/lib/pgsql/patroni"
patroni_pg_log_dir: "/var/log/postgresql"

# Patroni bootstrap용 계정(필수)
patroni_superuser: "{{ pg_superuser }}"
patroni_superuser_password: "{{ pg_superpass }}"

patroni_replication_user: "{{ replication_user }}"
patroni_replication_password: "{{ replication_pass }}"

# -----------------------------
# etcd
# -----------------------------
etcd_client_port: 2379
etcd_peer_port: 2380

# etcd endpoints (Patroni 템플릿에서 직접 사용) - 리스트 형태
# (호환성 유지용)

# etcd 버전(바이너리 설치 시 사용)
# etcd_bootstrap_reset: true
etcd_version: "v3.5.12"
etcd_download_url: "https://storage.googleapis.com/etcd/v3.5.12/etcd-v3.5.12-linux-amd64.tar.gz"


# -----------------------------
# DB 노드 식별(호스트명과 매핑)
# -----------------------------
db_nodes:
  db-a:
    ip: "10.2.3.2"
  db-s:
    ip: "10.2.3.3"
  db-b:
    ip: "10.2.3.4"

# -----------------------------
# 방화벽 정책(중요)
# -----------------------------
# DB 노드 방화벽에서 "인바운드 허용"할 소스 대역들
# - DB 노드끼리는 replication/leader bootstrap 때문에 필수
# - svc_subnet(Proxy/서비스)에서 DB 접속이 필요하면 5432는 허용해야 함
db_firewall_allowed_sources:
  - "{{ db_subnet_cidr }}"
  - "{{ svc_subnet_cidr }}"

# DB 노드에서 열어줄 인바운드 포트들
# - PostgreSQL(5432): DB끼리 + 서비스/프록시에서 접근
# - Patroni REST(8008): 보통 DB끼리만 써도 되지만 운영상 svc_subnet에서도 볼 수 있게 같이 허용
# - etcd(2379/2380): etcd를 DB노드에서 같이 돌리는 구조면 DB 대역만 허용해도 됨
db_firewall_ports:
  - { port: "{{ pg_port }}",           proto: "tcp", sources: "{{ db_firewall_allowed_sources }}", desc: "PostgreSQL" }
  - { port: "{{ patroni_rest_port }}", proto: "tcp", sources: "{{ db_firewall_allowed_sources }}", desc: "Patroni REST" }

# etcd는 보통 DB대역에서만 클러스터링하므로 DB 대역만 허용(권장)
db_firewall_etcd_sources:
  - "{{ db_subnet_cidr }}"
db_firewall_etcd_ports:
  - { port: "{{ etcd_client_port }}", proto: "tcp", sources: "{{ db_firewall_etcd_sources }}", desc: "etcd client" }
  - { port: "{{ etcd_peer_port }}",   proto: "tcp", sources: "{{ db_firewall_etcd_sources }}", desc: "etcd peer" }



  # Vault 로딩(플레이에서 include_vars로 읽는 구조라면 이 변수들은 아래처럼 매핑해서 씀)
# -----------------------------
# DB API 연동(DDL/테이블 담당 Role = dbT)
# group_vars/db/main.yml

app_db_name: "appdb"
app_schema: "app"
api_db_user: "api_app"
svc_api_password: "{{vault_svc_api_password}}"
api_db_password: "{{vault_api_db_password}}"
dbt_db_user: "dbT"
api_schema: "api"
svc_api_role: "svc_api"
haproxy_allowed_ips:
  - "10.2.3.1/32"
  - "10.2.3.10/32"
patroni_pg_hba_rules:
  - "local   all             all                                     peer"
  - "host    all             all             127.0.0.1/32             scram-sha-256"

  # DB 클러스터 내부는 반드시 허용(운영/복제)
  - "host    all             all             10.2.3.0/24              scram-sha-256"
  - "host    replication     {{ patroni_replication_user }} 10.2.3.0/24 scram-sha-256"
  - "host    all             {{ patroni_superuser }}       10.2.3.0/24 scram-sha-256"

  # API는 Proxy(DB망 IP)에서만 appdb로 접근 허용
  - "host    appdb           api_app         10.2.3.1/32              scram-sha-256"
  - "host    appdb           api_app         10.2.3.10/32             scram-sha-256"

  # 나머지 차단
  - "host    all             all             0.0.0.0/0               reject"

