# Generated by Ansible (iptables-services)
# external iface: {{ proxy_external_iface }}
# internal iface: {{ proxy_internal_iface }}
# internal cidr : {{ proxy_internal_cidr }}

# ============================================================
# MANGLE TABLE
# - TCP MSS Clamping (PMTU blackhole 방지)
# - Proxy를 경유하는 DB / ETCD / Backup VM의
#   HTTPS / pip / dnf / curl 스트리밍 연결 안정화
# ============================================================
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# 내부 -> 외부로 나가는 TCP SYN 패킷의 MSS를 경로 MTU에 맞게 강제
-A FORWARD -i {{ proxy_internal_iface }} -o {{ proxy_external_iface }} -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu

COMMIT


# ============================================================
# FILTER TABLE
# ============================================================
*filter
:INPUT ACCEPT [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# Allow loopback
-A INPUT -i lo -j ACCEPT

# Allow established/related
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# (옵션) SSH 허용 (원격 운영용)
-A INPUT -p tcp --dport 22 -j ACCEPT

# ICMP 허용 (ping 테스트용)
-A INPUT -p icmp -j ACCEPT

# =========================
# Forwarding rules
# =========================

# 내부 -> 외부 허용
-A FORWARD -i {{ proxy_internal_iface }} -o {{ proxy_external_iface }} -s {{ proxy_internal_cidr }} -j ACCEPT

# 외부 -> 내부(세션 응답) 허용
-A FORWARD -i {{ proxy_external_iface }} -o {{ proxy_internal_iface }} -d {{ proxy_internal_cidr }} -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

COMMIT


# ============================================================
# NAT TABLE
# ============================================================
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# =========================
# NAT (MASQUERADE)
# =========================

# 내부 subnet -> 외부 NAT
-A POSTROUTING -s {{ proxy_internal_cidr }} -o {{ proxy_external_iface }} -j MASQUERADE

COMMIT

