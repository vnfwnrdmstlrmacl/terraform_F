---
# roles/dbT/tasks/55_oauth_tables.yml
# "ìƒˆë¡œ ì‹œì‘" ì „ìš©: ê¸°ì¡´ í…Œì´ë¸” ìˆìœ¼ë©´ ë‹¤ DROP í•˜ê³  ë‹¤ì‹œ CREATE
# - users: í†µí•© í…Œì´ë¸” (ë¡œì»¬ username/password_hash + OAuth ì—°ë™)
# - oauth_accounts / oauth_tokens ìƒì„±
# - Primary(Leader)ì—ì„œë§Œ ì‹¤í–‰

- name: dbT - Reset OAuth/User tables (DROP & recreate)
  become: true
  become_user: postgres
  community.postgresql.postgresql_query:
    db: "{{ app_db_name }}"
    query: |
      -- ğŸ”¥ ìƒˆë¡œ ì‹œì‘: ê¸°ì¡´ ê²ƒ ì‹¹ ì‚­ì œ (ì˜ì¡´ì„± í¬í•¨)
      DROP TABLE IF EXISTS {{ app_schema }}.oauth_tokens CASCADE;
      DROP TABLE IF EXISTS {{ app_schema }}.oauth_accounts CASCADE;
      DROP TABLE IF EXISTS {{ app_schema }}.chat_logs CASCADE;
      DROP TABLE IF EXISTS {{ app_schema }}.users CASCADE;

      -- í™•ì¥
      CREATE EXTENSION IF NOT EXISTS pgcrypto;

      -- âœ… users (í†µí•©)
      CREATE TABLE {{ app_schema }}.users (
        user_id uuid PRIMARY KEY DEFAULT gen_random_uuid(),

        -- ê³µí†µ
        created_at timestamptz NOT NULL DEFAULT now(),
        updated_at timestamptz NOT NULL DEFAULT now(),
        status text NOT NULL DEFAULT 'active',
        role text NOT NULL DEFAULT 'ROLE_USER',

        -- ë¡œì»¬ íšŒì›ê°€ì… (OAuth-only ìœ ì €ëŠ” NULL ê°€ëŠ¥)
        username varchar(50),
        password_hash varchar(255),

        -- í”„ë¡œí•„/ì—°ë™ìš©
        email text,
        display_name text
      );

      -- usernameì€ ê°’ ìˆì„ ë•Œë§Œ ìœ ë‹ˆí¬
      CREATE UNIQUE INDEX uq_users_username
        ON {{ app_schema }}.users(username)
        WHERE username IS NOT NULL;

      CREATE INDEX idx_users_email
        ON {{ app_schema }}.users(email);

      -- âœ… oauth_accounts
      CREATE TABLE {{ app_schema }}.oauth_accounts (
        oauth_id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
        user_id uuid NOT NULL REFERENCES {{ app_schema }}.users(user_id) ON DELETE CASCADE,

        provider text NOT NULL,           -- google/kakao/naver
        provider_user_id text NOT NULL,   -- provider ê³ ìœ  ìœ ì € ID
        profile_image_url text,

        created_at timestamptz NOT NULL DEFAULT now(),
        updated_at timestamptz NOT NULL DEFAULT now(),

        UNIQUE(provider, provider_user_id),
        UNIQUE(user_id, provider)
      );

      CREATE INDEX idx_oauth_accounts_user_id
        ON {{ app_schema }}.oauth_accounts(user_id);

      CREATE INDEX idx_oauth_accounts_provider
        ON {{ app_schema }}.oauth_accounts(provider);

      -- âœ… oauth_tokens
      CREATE TABLE {{ app_schema }}.oauth_tokens (
        token_id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
        oauth_id uuid NOT NULL REFERENCES {{ app_schema }}.oauth_accounts(oauth_id) ON DELETE CASCADE,

        refresh_token text,
        expires_at timestamptz,
        scope text,

        created_at timestamptz NOT NULL DEFAULT now(),
        updated_at timestamptz NOT NULL DEFAULT now()
      );

      CREATE INDEX idx_oauth_tokens_oauth_id
        ON {{ app_schema }}.oauth_tokens(oauth_id);

      CREATE INDEX idx_oauth_tokens_expires_at
        ON {{ app_schema }}.oauth_tokens(expires_at);
  when: patroni_is_primary | bool
